import{FileLoader as e,Loader as t,Mesh as r,Vector2 as a,Vector3 as i,Matrix4 as s,Vector4 as n,MathUtils as l,MeshPhongMaterial as o,MeshBasicMaterial as u,BufferGeometry as c,Quaternion as h,Plane as f,TextureLoader as m,NearestFilter as p,LinearMipmapNearestFilter as g,RepeatWrapping as x,ClampToEdgeWrapping as d,MirroredRepeatWrapping as M,LinearSRGBColorSpace as R,SRGBColorSpace as w,FrontSide as T,DoubleSide as y,Group as F,BufferAttribute as k,EdgesGeometry as B,LineSegments as I,LineBasicMaterial as E}from"three";import{Earcut as b}from"three/src/extras/Earcut.js";import{SweepContext as A}from"poly2tri";const C={FACET:1,VERTEX:2},v={POINTCLOUD:1,WIREFRAME:2,SOLID:3},W={LIT:1,FORESHORTEN:2,FILTER:3},V={NONE:0,NULL:1,DOUBLE:2},S={WRAP:0,MIRROR:1,CLAMP:2},D=100,G=200,$=.2,X=[.69,0,0],L=/^.*(\.[^\\]+)$/i,U=/^\.(tiff|png|webp|gif)$/i;function N(e,t,r,a=R,i=x,s=!0){return new Promise((n=>{r.load(e,(e=>{e.image.height!==e.image.width&&e.image.height%e.image.width==0&&(t.userData.rwx.maskAnimation={yTiles:e.image.height/e.image.width,yHeight:e.image.width/e.image.height,step:0},e.offset.y=1-t.userData.rwx.maskAnimation.yHeight,e.repeat.set(1,t.userData.rwx.maskAnimation.yHeight)),e.wrapS=i,e.wrapT=i,e.colorSpace=a,s||(e.minFilter=g,e.magFilter=p),t.alphaMap=e,t.needsUpdate=!0,n(e)}))}))}function P(t,r,a,i=".jpg",s=null,n=".zip",l=null,o=[],u=w,c=x,h=$,f=!0){let d=new m,M=null;const T=L.exec(a);if(T&&(i="",U.test(T[1])&&(t.alphaTest=h,t.transparent=!0)),o.push(new Promise((e=>{M=r+"/"+a+i,d.load(M,(r=>{r.wrapS=c,r.wrapT=c,r.colorSpace=u,t.map=r,t.needsUpdate=!0,f||(r.minFilter=g,r.magFilter=p),r.image.height!==r.image.width&&r.image.height%r.image.width==0&&(t.userData.rwx.animation={yTiles:r.image.height/r.image.width,yHeight:r.image.width/r.image.height,step:0},r.offset.y=1-t.userData.rwx.animation.yHeight,r.repeat.set(1,t.userData.rwx.animation.yHeight)),e(r)}))}))),null!=s)if(t.alphaTest=h,t.transparent=!0,".zip"==n&&null!=l){const a=s,i=r+"/"+a+n;o.push(new Promise(((r,s)=>{const n=new e;n.setResponseType("arraybuffer"),n.load(i,(e=>{const n=l.unzipSync(new Uint8Array(e));let o=null;for(const e of Object.keys(n))if(e.toLowerCase()==a.toLowerCase()+".bmp"){o=e;break}o||s(new Error(`No .bmp file candidate found within '${i}'`));const u=n[o];let h="data:image/bmp;base64,";let m="";for(let e=0;e<u.length;e+=4056)m=m.concat(String.fromCharCode.apply(null,new Uint16Array(u.slice(e,e+4056))));h=h.concat(btoa(m)),N(h,t,d,R,c,f).then((e=>{r(e)}))}),null,(e=>{s(e)}))})))}else if(".zip"!=n){const e=r+"/"+s+n;o.push(N(e,t,d,R,c,f))}}function H(e,t,r=".jpg",a=".zip",i=null,s=!1,n=w,l=$){let c={name:e.getMatSignature()};e.materialmode==V.NULL?c.side=T:e.materialmode==V.DOUBLE?c.side=y:e.materialmode==V.NONE&&(c.visible=!1),e.opacity<1&&(c.transparent=!0),e.geometrysampling<v.SOLID?c.wireframe=!0:c.wireframe=!1;const h=e.texturemodes.includes(W.FILTER);let f=d;e.textureaddressmode==S.WRAP?f=x:e.textureaddressmode==S.MIRROR&&(f=M);const m=e.texturemodes.includes(W.LIT)?e.surface:X;if(!s){e.lightsampling==C.FACET?c.flatShading=!0:e.lightsampling==C.VERTEX&&(c.flatShading=!1);const t=Math.trunc(.1*m[2]*255);c.specular=(t<<16)+(t<<8)+t;const r=Math.trunc(m[1]);c.emissive=(r<<16)+(r<<8)+r,c.shininess=30}c.opacity=e.opacity;let p=s?new u(c):new o(c);p.userData.rwx={material:e.clone()};let g=[];p.userData.collision=e.collision,p.userData.ratio=e.ratio;const R=Math.max(...m);return null==e.texture?(p.color.set(e.getColorHexValue()),p.color.multiplyScalar(R)):(p.color.set(16777215),p.color.multiplyScalar(R),P(p,t,e.texture,r,e.mask,a,i,g,n,f,l,h)),p.needsUpdate=!0,{threeMat:p,loadingPromises:g}}function z(e){e.currentBufferFaceCount>0&&_(e),e.currentBufferGeometry=new c,e.currentBufferVertices=[],e.currentBufferUVs=[],e.currentBufferFaces=[],e.currentBufferFaceCount=0,e.currentBufferGroupFirstFaceID=0,e.previousMaterialID=null}function O(e){if(e.currentBufferFaceCount>0&&_(e),e.currentBufferFaces.length>0){e.currentBufferGeometry.setAttribute("position",new k(new Float32Array(e.currentBufferVertices),3)),e.currentBufferGeometry.setAttribute("uv",new k(new Float32Array(e.currentBufferUVs),2)),e.currentBufferGeometry.setIndex(e.currentBufferFaces),e.currentBufferGeometry.uvsNeedUpdate=!0,e.currentBufferGeometry.computeVertexNormals(),e.loadingPromises=e.loadingPromises.concat(e.materialTracker.getCommitedMaterialList().map((e=>e.loadingPromises)));const t=new r(e.currentBufferGeometry,e.materialTracker.getCommitedMaterialList().map((e=>e.threeMat)));t.userData.taggedMaterials=e.taggedMaterials,e.currentGroup.add(t),ce(e),fe(e),e.taggedMaterials={}}}function _(e){e.currentBufferFaceCount&&e.currentBufferGeometry.addGroup(e.currentBufferGroupFirstFaceID,3*e.currentBufferFaceCount,e.previousMaterialID),e.materialTracker.commitMaterials(),e.previousMaterialID=e.materialTracker.getCurrentMaterialID(),e.currentBufferGroupFirstFaceID+=3*e.currentBufferFaceCount,e.currentBufferFaceCount=0}function q(e,t,r,a){e.materialTracker.getCurrentMaterialID()!==e.previousMaterialID&&_(e),e.currentBufferFaceCount++,e.currentBufferFaces.push(t,r,a)}function j(e,t,r,a,i){if(e.materialTracker.getCurrentMaterialID()!==e.previousMaterialID&&_(e),e.materialTracker.currentRWXMaterial.geometrysampling==v.WIREFRAME){const s=new c;s.setAttribute("position",new k(new Float32Array([e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2],e.currentBufferVertices[3*r],e.currentBufferVertices[3*r+1],e.currentBufferVertices[3*r+2],e.currentBufferVertices[3*a],e.currentBufferVertices[3*a+1],e.currentBufferVertices[3*a+2],e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2],e.currentBufferVertices[3*a],e.currentBufferVertices[3*a+1],e.currentBufferVertices[3*a+2],e.currentBufferVertices[3*i],e.currentBufferVertices[3*i+1],e.currentBufferVertices[3*i+2]]),3)),s.computeVertexNormals();const n=new I(new B(s),new E({color:e.materialTracker.currentRWXMaterial.getColorHexValue()}));e.currentGroup.add(n)}else e.currentBufferFaceCount+=2,e.currentBufferFaces.push(t,r,a),e.currentBufferFaces.push(t,a,i)}function Z(e,t){const r=e.materialTracker.currentRWXMaterial.lightsampling;e.materialTracker.currentRWXMaterial.lightsampling=C.FACET,e.materialTracker.getCurrentMaterialID()!==e.previousMaterialID&&_(e);const a=function(e,t,r,a,n=!1,l=!1){const o=new i;let u=new s;const c=new f,m=new h,p=new i,g=new i,x=new i(1,0,0),d=new i(0,0,1);let M=new i;const R=[];o.setScalar(0);let w=r.length;for(let t=0;t<w;t++)o.add(new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2])),R.push(r[t]);o.multiplyScalar(1/w);let T=new i(0,0,0);for(let t=0;t<w;t++){const a=new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2]);let s=new i(e[3*r[(t+1)%w]],e[3*r[(t+1)%w]+1],e[3*r[(t+1)%w]+2]);T.x+=(a.y-s.y)*(a.z+s.z),T.y+=(a.z-s.z)*(a.x+s.x),T.z+=(a.x-s.x)*(a.y+s.y)}T.normalize();const y=new i(e[3*r[0]],e[3*r[0]+1],e[3*r[0]+2]);c.setFromNormalAndCoplanarPoint(T,y);let F=c.normal;m.setFromUnitVectors(d,F),g.copy(x).applyQuaternion(m),p.crossVectors(g,F),p.normalize(),u.makeBasis(g,p,F),u.setPosition(o);let k=[],B=[];for(let t=0;t<w;t++){const a=new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2]);M.subVectors(a,o),n||k.push({x:M.dot(g),y:M.dot(p),id:R[t]}),B.push(M.dot(g),M.dot(p))}let I=[];if(!n)try{const e=new A(k);e.triangulate();const t=e.getTriangles();for(const e of t)I.push(e.getPoint(0).id,e.getPoint(1).id,e.getPoint(2).id);return I}catch(e){l&&console.warn("Could not use poly2tri here for "+a+" (falling back to Earcut): "+e)}return I=b.triangulate(B,null,2).map((e=>R[e])),I}(e.currentBufferVertices,e.currentBufferUVs,t,e.objectName,e.forceEarcut,e.verboseWarning);for(let t=0;t<a.length;t+=3){const r=a[t],i=a[t+1],s=a[t+2];e.currentBufferFaceCount++,e.currentBufferFaces.push(r,i,s)}e.materialTracker.currentRWXMaterial.lightsampling=r}function Q(e,t,r,a=null){if(r<3)throw new Error("Need at least 3 sides to make a vertex circle");let s=[],n=[],l=new i;const o=2*Math.PI/r,u=new i(0,1,0);l.add(new i(t,0,0));for(let t=0;t<r;t++)s.push(l.x,l.y+e,l.z),l.applyAxisAngle(u,o),null===a?n.push((Math.cos(o*t)+1)/2,(Math.sin(o*t)+1)/2):n.push(1/r*t,a);return[s,n]}function Y(e,t,a,i){let s=new c,n=e.materialTracker.getCurrentMaterial().threeMat;void 0===n.flatShading||n.flatShading||(n=n.clone(),n.flatShading=!0);const l=[-t/2,a/2,-i/2,t/2,a/2,-i/2,t/2,a/2,i/2,-t/2,a/2,i/2,-t/2,-a/2,-i/2,t/2,-a/2,-i/2,t/2,-a/2,i/2,-t/2,-a/2,i/2];s.setAttribute("position",new k(new Float32Array(l),3)),s.setAttribute("uv",new k(new Float32Array([0,0,1,0,1,1,0,1,1,1,0,1,0,0,1,0]),2)),s.setIndex([0,3,1,1,3,2,0,4,3,3,4,7,3,6,2,3,7,6,6,7,5,5,7,4,1,5,0,0,5,4,2,5,1,6,5,2]),s.addGroup(0,36,0),s.uvsNeedUpdate=!0,s.computeVertexNormals();let o=new r(s,[n]);o.userData.taggedMaterials={},o.applyMatrix4(e.currentTransform),e.currentGroup.add(o)}function J(e,t,a,i){if(i<3)return;let s=new c,[n,l]=Q(0,a,i);n.push(0,t,0),l.push(.5,.5),s.setAttribute("position",new k(new Float32Array(n),3)),s.setAttribute("uv",new k(new Float32Array(l),2));let o=[];for(let e=0;e<i;e++)o.push(i,e,(e+1)%i);s.setIndex(o),s.addGroup(0,3*i,0),s.uvsNeedUpdate=!0,s.computeVertexNormals();let u=new r(s,[e.materialTracker.getCurrentMaterial().threeMat]);u.userData.taggedMaterials={},u.applyMatrix4(e.currentTransform),e.currentGroup.add(u)}function K(e,t,a,i,s){if(s<3)return;let[n,l]=Q(0,a,s,1);const o=Q(t,i,s,0);n.push(...o[0]),l.push(...o[1]);let u=new c;u.setAttribute("position",new k(new Float32Array(n),3)),u.setAttribute("uv",new k(new Float32Array(l),2));const h=s;let f=[];for(let e=0;e<s;e++)f.push(h+e,e,(e+1)%s),f.push(h+e,(e+1)%s,h+(e+1)%s);u.setIndex(f),u.addGroup(0,6*s,0),u.uvsNeedUpdate=!0,u.computeVertexNormals();let m=new r(u,[e.materialTracker.getCurrentMaterial().threeMat]);m.userData.taggedMaterials={},m.applyMatrix4(e.currentTransform),e.currentGroup.add(m)}function ee(e,t,a,i){if(i<3)return;let s=new c,[n,l]=Q(t,a,i);s.setAttribute("position",new k(new Float32Array(n),3)),s.setAttribute("uv",new k(new Float32Array(l),2));let o=[];for(let e=1;e<i;e++)o.push(0,e,(e+1)%i);s.setIndex(o),s.addGroup(0,3*i,0),s.uvsNeedUpdate=!0,s.computeVertexNormals();let u=new r(s,[e.materialTracker.getCurrentMaterial().threeMat]);u.applyMatrix4(e.currentTransform),u.userData.taggedMaterials={},e.currentGroup.add(u)}function te(e,t,a){if(a<2)return;const i=4*a,s=a,n=Math.PI/(2*s);let[l,o]=Q(0,t,i,1),u=0,h=0,f=[];for(let e=1;e<s;e++){h=u+i;const r=Math.sin(n*e),a=Q(r*t,Math.cos(n*e)*t,i,r);l.push(...a[0]),o.push(...a[1]);for(let e=0;e<i;e++)f.push(h+e,u+e,u+(e+1)%i,h+e,u+(e+1)%i,h+(e+1)%i);u=h}l.push(0,t,0),o.push(.5,0);const m=l.length/3-1;for(let e=0;e<i;e++)f.push(m,u+e,u+(e+1)%i);let p=new c;p.setAttribute("position",new k(new Float32Array(l),3)),p.setAttribute("uv",new k(new Float32Array(o),2)),p.setIndex(f),p.addGroup(0,p.getIndex().count,0),p.uvsNeedUpdate=!0,p.computeVertexNormals();let g=new r(p,[e.materialTracker.getCurrentMaterial().threeMat]);g.userData.taggedMaterials={},g.applyMatrix4(e.currentTransform),e.currentGroup.add(g)}function re(e,t,a){if(a<2)return;const i=4*a,s=a,n=Math.PI/(2*s),l=[0,-t,0],o=[.5,0];let u=1-s;const h=Math.sin(n*u);let f=Q(h*t,Math.cos(n*u)*t,i,h);l.push(...f[0]),o.push(...f[1]);let m=0,p=1;const g=[];for(let e=0;e<i;e++)g.push(m,p+(e+1)%i,p+e);for(m=p,u++;u<s;u++){p=m+i;const e=Math.sin(n*u);f=Q(e*t,Math.cos(n*u)*t,i,e),l.push(...f[0]),o.push(...f[1]);for(let e=0;e<i;e++)g.push(p+e,m+e,m+(e+1)%i,p+e,m+(e+1)%i,p+(e+1)%i);m=p}l.push(0,t,0),o.push(.5,0),p+=i;for(let e=0;e<i;e++)g.push(p,m+e,m+(e+1)%i);let x=new c;x.setAttribute("position",new k(new Float32Array(l),3)),x.setAttribute("uv",new k(new Float32Array(o),2)),x.setIndex(g),x.addGroup(0,x.getIndex().count,0),x.uvsNeedUpdate=!0,x.computeVertexNormals();let d=new r(x,[e.materialTracker.getCurrentMaterial().threeMat]);d.userData.taggedMaterials={},d.applyMatrix4(e.currentTransform),e.currentGroup.add(d)}function ae(e){let t=new F;t.userData.rwx={},t.applyMatrix4(e.currentTransform),e.currentGroup.add(t),e.currentGroup=t,e.currentTransform=new s}function ie(e){e.currentTransform=e.currentGroup.matrix.clone(),e.currentGroup=e.currentGroup.parent}function se(e){e.materialStack.push(e.materialTracker.currentRWXMaterial),e.materialTracker.currentRWXMaterial=e.materialTracker.currentRWXMaterial.clone(),e.materialTracker.clearCurrentMaterialList(e.materialTracker.currentRWXMaterial)}function ne(e){e.materialTracker.currentRWXMaterial=e.materialStack.pop(),e.materialTracker.clearCurrentMaterialList(e.materialTracker.currentRWXMaterial)}function le(e){e.transformSaves.push(e.currentTransform.clone())}function oe(e){e.transformSaves.length>0?e.currentTransform=e.transformSaves.pop():e.currentTransform=new s}function ue(e,t){e.materialTracker.currentRWXMaterial.tag=t,void 0===e.taggedMaterials[t.toString()]&&(e.taggedMaterials[t.toString()]=[]),e.taggedMaterials[t.toString()].includes(e.materialTracker.getCurrentMaterialID())||e.taggedMaterials[t.toString()].push(e.materialTracker.getCurrentMaterialID())}function ce(e){e.materialTracker.currentRWXMaterial.tag=0}function he(e,t,r,s,n=null){const l=new i(e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2]),o=new i(e.currentBufferVertices[3*r],e.currentBufferVertices[3*r+1],e.currentBufferVertices[3*r+2]),u=new i(e.currentBufferVertices[3*s],e.currentBufferVertices[3*s+1],e.currentBufferVertices[3*s+2]),c=new a(e.currentBufferUVs[2*t],e.currentBufferUVs[2*t+1]),h=new a(e.currentBufferUVs[2*r],e.currentBufferUVs[2*r+1]),f=new a(e.currentBufferUVs[2*s],e.currentBufferUVs[2*s+1]),m=Math.max(c.x,h.x,f.x),p=Math.max(c.y,h.y,f.y),g=Math.min(c.x,h.x,f.x),x=(m+g)/2,d=1/(m-g),M=1/(p-Math.min(c.y,h.y,f.y));let R=1,w=1,T=u,y=f,F=[l,o],k=[c,h],B=l.distanceToSquared(o);const I=l.distanceToSquared(u),E=o.distanceToSquared(u);I>B&&(B=I,T=o,F=[l,u],y=h,k=[c,f]),E>B&&(B=E,T=l,F=[o,u],y=c,k=[h,f]),y.x<x&&(k[0].x>x?(R=T.distanceTo(F[0]),w=T.distanceTo(F[1])):(R=T.distanceTo(F[1]),w=T.distanceTo(F[0]))),y.x>x&&(k[0].x<x?(R=T.distanceTo(F[0]),w=T.distanceTo(F[1])):(R=T.distanceTo(F[1]),w=T.distanceTo(F[0])));const b=R*d/(w*M);e.materialTracker.currentRWXMaterial.ratio=b,null===n?null===e.triangleRatioHint?e.triangleRatioHint=b:e.materialTracker.currentRWXMaterial.ratio=e.triangleRatioHint:null===e.quadRatioHint?e.quadRatioHint=b:e.materialTracker.currentRWXMaterial.ratio=e.quadRatioHint}function fe(e){e.materialTracker.currentRWXMaterial.ratio=1}function me(e,t,a=e.matrix){e.children.forEach((e=>{let i=new s;if(i.copy(a),i.multiply(e.matrix),e instanceof r&&t.meshFilter(e)){let r=[];const a=e.geometry.getIndex().array;if("function"==typeof e.material[Symbol.iterator]){e.geometry.groups.forEach((e=>{r.push({start:e.start+t.indices.length,count:e.count,materialIndex:e.materialIndex+t.materials.length})}));const a=e.userData.taggedMaterials;if(void 0!==a)for(const[e,r]of Object.entries(a))void 0===t.taggedMaterials[e]&&(t.taggedMaterials[e]=[]),r.forEach((r=>{t.taggedMaterials[e].push(r+t.materials.length)}));t.materials.push(...e.material)}else r.push({start:t.indices.length,count:a.length,materialIndex:t.materials.length}),t.materials.push(e.material);const s=e.geometry.getAttribute("position").array,l=t.positions.length/3;let o=0;for(let e=s.length/3;o<e;o++){let e=new n(s[3*o],s[3*o+1],s[3*o+2]);e.applyMatrix4(i),t.positions.push(e.x),t.positions.push(e.y),t.positions.push(e.z)}if(void 0===e.geometry.getAttribute("uv")){const e=new Array(2*o).fill(0);t.uvs.push(...e)}else t.uvs.push(...e.geometry.getAttribute("uv").array);t.indices.push(...a.map((e=>e+l))),r.forEach((e=>{t.bufferGeometry.addGroup(e.start,e.count,e.materialIndex)}))}else e instanceof F&&me(e,t,i)}))}function pe(e,t=(()=>!0)){let a={bufferGeometry:new c,positions:[],uvs:[],indices:[],materials:[],taggedMaterials:{},meshFilter:t};me(e,a),a.bufferGeometry.setAttribute("position",new k(new Float32Array(a.positions),3)),a.bufferGeometry.setAttribute("uv",new k(new Float32Array(a.uvs),2)),a.bufferGeometry.setIndex(a.indices),a.bufferGeometry.uvsNeedUpdate=!0,a.bufferGeometry.computeVertexNormals();let i=new r(a.bufferGeometry,a.materials);return i.userData.rwx=e.userData.rwx,i.userData.taggedMaterials=a.taggedMaterials,i}class ge{constructor(){this.color=[0,0,0],this.surface=X.slice(0,3),this.opacity=1,this.lightsampling=C.FACET,this.geometrysampling=v.SOLID,this.texturemodes=[W.LIT,W.FORESHORTEN,W.FILTER],this.materialmode=V.NULL,this.texture=null,this.mask=null,this.textureaddressmode=S.WRAP,this.collision=!0,this.tag=0,this.ratio=1}clone(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e.color=[...this.color],e.surface=[...this.surface],e.texturemodes=[...this.texturemodes],e}getColorHexValue(){return(Math.trunc(255*this.color[0])<<16)+(Math.trunc(255*this.color[1])<<8)+Math.trunc(255*this.color[2])}getMatSignature(){const e=this.color[0].toFixed(3)+this.color[1].toFixed(3)+this.color[2].toFixed(3),t=this.surface[0].toFixed(3)+this.surface[1].toFixed(3)+this.surface[2].toFixed(3),r=this.opacity.toFixed(3),a=this.lightsampling.toString(),i=this.geometrysampling.toString();let s="";this.texturemodes.forEach((e=>{s+=e.toString()}));const n=this.materialmode.toString(),l=null===this.texture?"":this.texture,o=null===this.mask?"":this.mask,u=this.textureaddressmode.toString(),c=this.collision.toString(),h=this.tag.toString(),f=this.ratio.toFixed(2);return`${e}_${t}_${r}_${a}_${i}_${s}_${n}_${l}_${o}_${u}_${c}_${h}_${f}`}}class xe{constructor(e,t=".jpg",r=".zip",a=null,i=!1,s=w,n=$){this.threeMaterialMap=new Map,this.folder=e,this.textureExtension=t,this.maskExtension=r,this.fflate=a,this.useBasicMaterial=i,this.textureColorSpace=s,this.alphaTest=n}addRWXMaterial(e,t=null){const r=t||e.getMatSignature(),a=H(e,this.folder,this.textureExtension,this.maskExtension,this.fflate,this.useBasicMaterial,this.textureColorSpace,this.alphaTest);a.signature=r,this.threeMaterialMap.set(r,a)}hasThreeMaterialPack(e){return this.threeMaterialMap.has(e)}getThreeMaterialPack(e){return this.threeMaterialMap.get(e)}removeThreeMaterialPack(e){this.threeMaterialMap.delete(e)}clear(){this.threeMaterialMap.clear()}texturesNextFrame(){for(const e of this.threeMaterialMap){const t=e[1].threeMat.userData.rwx.animation,r=e[1].threeMat.userData.rwx.maskAnimation;void 0!==t&&(t.step=(t.step+1)%t.yTiles,e[1].threeMat.map.offset.y=1-t.yHeight-t.step*t.yHeight,e[1].threeMat.needsUpdate=!0),void 0!==r&&(r.step=(r.step+1)%r.yTiles,e[1].threeMat.alphaMap.offset.y=1-r.yHeight-r.step*r.yHeight,e[1].threeMat.needsUpdate=!0)}}}class de{constructor(e){this.manager=e,this.currentRWXMaterial=new ge,this.currentMaterialID=null,this.currentMaterialList=[],this.signatureMap=new Map,this.commitedMaterialsAmount=0,this.currentMaterialSignature=""}getCurrentMaterialID(){const e=this.currentRWXMaterial.getMatSignature();return this.signatureMap.has(e)?(this.currentMaterialSignature=e,this.signatureMap.get(e)):(this.manager.hasThreeMaterialPack(e)||this.manager.addRWXMaterial(this.currentRWXMaterial,e),this.currentMaterialSignature!=e&&(this.currentMaterialSignature=e,null===this.currentMaterialID?this.currentMaterialID=0:this.currentMaterialID++,this.signatureMap.set(e,this.currentMaterialID),this.currentMaterialList.push(this.manager.getThreeMaterialPack(e))),this.currentMaterialID)}getCurrentMaterial(){return this.currentMaterialList[this.getCurrentMaterialID()]}getCurrentMaterialList(){return this.currentMaterialList}clearCurrentMaterialList(e=new ge){this.currentMaterialID=null,this.currentMaterialList=[],this.signatureMap.clear(),this.currentMaterialSignature="",this.currentRWXMaterial=e,this.commitedMaterialsAmount=0}commitMaterials(){this.commitedMaterialsAmount=this.currentMaterialList.length}getCommitedMaterialList(){return this.currentMaterialList.slice(0,this.commitedMaterialsAmount)}}export default class extends t{constructor(e){super(e),this.integerRegex=/([-+]?[0-9]+)/g,this.floatRegex=/([+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)([eE][-+][0-9]+)?)/g,this.nonCommentRegex=/^(.*)#(?!\!)/g,this.clumpbeginRegex=/^ *(clumpbegin).*$/i,this.clumpendRegex=/^ *(clumpend).*$/i,this.transformbeginRegex=/^ *(transformbegin).*$/i,this.transformendRegex=/^ *(transformend).*$/i,this.protobeginRegex=/^ *(protobegin) +([A-Za-z0-9_\-\.]+).*$/i,this.protoinstanceRegex=/^ *(protoinstance) +([A-Za-z0-9_\-\.]+).*$/i,this.protoendRegex=/^ *(protoend).*$/i,this.vertexRegex=/^ *(vertex|vertexext)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}) *(uv(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){2}))?.*$/i,this.polygonRegex=/^ *(polygon|polygonext)( +[0-9]+)(( +[0-9]+)+)( +tag +([0-9]+))?.*$/i,this.quadRegex=/^ *(quad|quadext)(( +([0-9]+)){4})( +tag +([0-9]+))?.*$/i,this.triangleRegex=/^ *(triangle|triangleext)(( +([0-9]+)){3})( +tag +([0-9]+))?.*$/i,this.textureRegex=/^ *(texture) +([A-Za-z0-9_\-]+)*(\.[A-Za-z]+)? *(mask *([A-Za-z0-9_\-]+))?.*$/i,this.colorRegex=/^ *(color)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}).*$/i,this.opacityRegex=/^ *(opacity)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?).*$/i,this.identityRegex=/^ *(identity) *$/i,this.transformRegex=/^ *(transform)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){16}).*$/i,this.translateRegex=/^ *(translate)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}).*$/i,this.scaleRegex=/^ *(scale)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}).*$/i,this.rotateRegex=/^ *(rotate)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){4})$/i,this.surfaceRegex=/^ *(surface)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}).*$/i,this.ambientRegex=/^ *(ambient)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?).*$/i,this.diffuseRegex=/^ *(diffuse)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?).*$/i,this.specularRegex=/^ *(specular)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?).*$/i,this.materialModeRegex=/^ *((add)?materialmode(s)?) +([A-Za-z0-9_\-]+).*$/i,this.collisionRegex=/^ *(collision) +(on|off).*$/i,this.lightsamplingRegex=/^ *(lightsampling) +(facet|vertex).*$/i,this.geometrysamplingRegex=/^ *(geometrysampling) +(pointcloud|wireframe|solid).*$/i,this.texturemodesRegex=/^ *(texturemode(s)?)(( +null)|( +lit| +foreshorten| +filter)+).*$/i,this.addtexturemodeRegex=/^ *(addtexturemode)( +lit| +foreshorten| +filter).*$/i,this.removetexturemodeRegex=/^ *(removetexturemode)( +lit| +foreshorten| +filter).*$/i,this.textureaddressmodeRegex=/^ *(#\!)? *(textureaddressmode) +(wrap|mirror|clamp).*$/i,this.axisalignmentRegex=/^ *(axisalignment) +(none|zorientx|zorienty|xyz).*$/i,this.blockRegex=/^ *(block)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}).*$/i,this.coneRegex=/^ *(cone)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){2}( +[-+]?[0-9]+)).*$/i,this.cylinderRegex=/^ *(cylinder)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){3}( +[-+]?[0-9]+)).*$/i,this.discRegex=/^ *(disc)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?){2}( +[-+]?[0-9]+)).*$/i,this.hemisphereRegex=/^ *(hemisphere)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?)( +[-+]?[0-9]+)).*$/i,this.sphereRegex=/^ *(sphere)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)(e[-+][0-9]+)?)( +[-+]?[0-9]+)).*$/i,this.tagRegex=/^ *(tag)( +[-+]?[0-9]+).*$/i,this.fflate=null,this.textureExtension=".jpg",this.maskExtension=".zip",this.waitFullLoad=!1,this.flatten=!1,this.useBasicMaterial=!1,this.rwxMaterialManager=null,this.textureColorSpace=w,this.enableTextures=!0,this.forceEarcut=!1,this.verboseWarning=!1,this.alphaTest=$,this.forceTextureFiltering=!0}setFflate(e){return this.fflate=e,this}setTextureExtension(e){return this.textureExtension=e,this}setMaskExtension(e){return this.maskExtension=e,this}setWaitFullLoad(e){return this.waitFullLoad=e,this}setFlatten(e){return this.flatten=e,this}setUseBasicMaterial(e){return this.useBasicMaterial=e,this}setRWXMaterialManager(e){return this.rwxMaterialManager=e,this}setTextureColorSpace(e){return this.textureColorSpace=e,this}setEnableTextures(e){return this.enableTextures=e,this}setForceEarcut(e){return this.forceEarcut=e,this}setVerboseWarning(e){return this.verboseWarning=e,this}setAlphaTest(e){return this.alphaTest=e,this}setForceTextureFiltering(e){return this.forceTextureFiltering=e,this}load(t,r,a,i){let s=this,n=this.path,l=this.resourcePath,o=new e(this.manager);o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(n+"/"+t,(function(e){try{s.parse(t,e,l,(function(e){r(e)}))}catch(e){i?i(e):console.error(e),s.manager.itemError(t)}}),a,i)}parse(e,t,r,a){let i={rootGroup:null,currentGroup:null,transformSaves:[],materialStack:[],currentTransform:new s,currentBufferGeometry:null,currentBufferVertices:[],currentBufferUVs:[],currentBufferFaces:[],currentBufferFaceCount:0,currentBufferGroupFirstFaceID:0,previousMaterialID:null,rwxClumpStack:[],rwxPrototypes:new Map,loadingPromises:[],materialTracker:null!==this.rwxMaterialManager?new de(this.rwxMaterialManager):new de(new xe(r,this.textureExtension,this.maskExtension,this.fflate,this.useBasicMaterial,this.textureColorSpace,this.alphaTest)),taggedMaterials:{},quadRatioHint:null,triangleRatioHint:null,forceEarcut:this.forceEarcut,verboseWarning:this.verboseWarning,objectName:this.path+"/"+e},o=null,u=null;const c=new s;c.makeScale(10,10,10);const h=t.split(/[\n\r]+/g);i.rootGroup=new F,i.rootGroup.userData.rwx={axisAlignment:"none"},i.currentGroup=i.rootGroup,i.materialStack.push(i.materialTracker.currentMaterial);for(let e=0,t=h.length;e<t;e++){let t=h[e],r=this.nonCommentRegex.exec(t);if(null!=r&&(t=r[1]),t=t.trim().replace(/\t/g," "),r=this.clumpbeginRegex.exec(t),null==r)if(r=this.clumpendRegex.exec(t),null==r)if(r=this.transformbeginRegex.exec(t),null==r)if(r=this.transformendRegex.exec(t),null==r)if(r=this.protobeginRegex.exec(t),null==r)if(r=this.protoendRegex.exec(t),null==r)if(r=this.protoinstanceRegex.exec(t),null==r)if(r=this.textureRegex.exec(t),this.enableTextures&&null!=r){const e=null!=r[3]?r[3].toLowerCase():".jpg",t=r[2].toLowerCase();i.materialTracker.currentRWXMaterial.texture="null"==t?null:".jpg"!==e?t+e:t,void 0!==r[4]?i.materialTracker.currentRWXMaterial.mask=r[5]:i.materialTracker.currentRWXMaterial.mask=null}else if(r=this.triangleRegex.exec(t),null==r)if(i.triangleRatioHint=null,r=this.quadRegex.exec(t),null==r)if(i.quadRatioHint=null,r=this.polygonRegex.exec(t),null==r)if(r=this.vertexRegex.exec(t),null==r)if(r=this.colorRegex.exec(t),null==r)if(r=this.opacityRegex.exec(t),null==r)if(r=this.identityRegex.exec(t),null==r)if(r=this.transformRegex.exec(t),null==r)if(r=this.translateRegex.exec(t),null==r)if(r=this.rotateRegex.exec(t),null==r)if(r=this.scaleRegex.exec(t),null==r)if(r=this.surfaceRegex.exec(t),null==r)if(r=this.ambientRegex.exec(t),null==r)if(r=this.diffuseRegex.exec(t),null==r)if(r=this.specularRegex.exec(t),null==r)if(r=this.materialModeRegex.exec(t),null==r)if(r=this.collisionRegex.exec(t),null==r)if(r=this.lightsamplingRegex.exec(t),null==r)if(r=this.geometrysamplingRegex.exec(t),null==r){if(r=this.texturemodesRegex.exec(t),null==r)if(r=this.addtexturemodeRegex.exec(t),null==r)if(r=this.removetexturemodeRegex.exec(t),null==r)if(r=this.textureaddressmodeRegex.exec(t),null==r)if(r=this.axisalignmentRegex.exec(t),null==r)if(r=this.blockRegex.exec(t),null==r)if(r=this.coneRegex.exec(t),null==r)if(r=this.cylinderRegex.exec(t),null==r)if(r=this.discRegex.exec(t),null==r)if(r=this.hemisphereRegex.exec(t),null==r)if(r=this.sphereRegex.exec(t),null==r)r=this.tagRegex.exec(t),null==r||(i.currentGroup.userData.rwx.tag=parseInt(r[2]));else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(1==r?parseInt(t):parseFloat(t))})),re(i,e[0],e[1])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(1==r?parseInt(t):parseFloat(t))})),te(i,e[0],e[1])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(2==r?parseInt(t):parseFloat(t))})),ee(i,e[0],e[1],e[2])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(3==r?parseInt(t):parseFloat(t))})),K(i,e[0],e[1],e[2],e[3])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(2==r?parseInt(t):parseFloat(t))})),J(i,e[0],e[1],e[2])}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),Y(i,e[0],e[1],e[2])}else i.rootGroup.userData.rwx.axisAlignment=r[2].toLowerCase();else{const e=r[3].toUpperCase();i.materialTracker.currentRWXMaterial.textureaddressmode=S[e]}else{const e=r[2].trim().toUpperCase();if(this.forceTextureFiltering&&W[e]===W.FILTER)continue;const t=i.materialTracker.currentRWXMaterial.texturemodes.indexOf(W[e]);t>=0&&(i.materialTracker.currentRWXMaterial.texturemodes.splice(t,1),i.materialTracker.currentRWXMaterial.texturemodes.sort())}else{const e=r[2].trim().toUpperCase();i.materialTracker.currentRWXMaterial.texturemodes.includes(W[e])||(i.materialTracker.currentRWXMaterial.texturemodes.push(W[e]),i.materialTracker.currentRWXMaterial.texturemodes.sort())}else if(i.materialTracker.currentRWXMaterial.texturemodes=[],!r[4]){const e=r[3].split(" ").filter((e=>""!==e)).map((e=>e.toUpperCase()));for(const t of e)i.materialTracker.currentRWXMaterial.texturemodes.includes(W[t])||i.materialTracker.currentRWXMaterial.texturemodes.push(W[t]);this.forceTextureFiltering&&!i.materialTracker.currentRWXMaterial.texturemodes.includes(W.FILTER)&&i.materialTracker.currentRWXMaterial.texturemodes.push(W.FILTER),i.materialTracker.currentRWXMaterial.texturemodes.sort()}}else{const e=r[2].toUpperCase();i.materialTracker.currentRWXMaterial.geometrysampling=v[e]}else{const e=r[2].toUpperCase();i.materialTracker.currentRWXMaterial.lightsampling=C[e]}else{const e=r[2].toLowerCase();"on"==e?i.materialTracker.currentRWXMaterial.collision=!0:"off"==e&&(i.materialTracker.currentRWXMaterial.collision=!1)}else{const e=r[4].toUpperCase();i.materialTracker.currentRWXMaterial.materialmode=V[e]}else i.materialTracker.currentRWXMaterial.surface[2]=parseFloat(r[2]);else i.materialTracker.currentRWXMaterial.surface[1]=parseFloat(r[2]);else i.materialTracker.currentRWXMaterial.surface[0]=parseFloat(r[2]);else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),i.materialTracker.currentRWXMaterial.surface=e}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new s;3==e.length&&(t.makeScale(e[0],e[1],e[2]),i.currentTransform.multiply(t))}else{let e=[];if(r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),4==e.length){let t=new s;e[0]&&(t.makeRotationX(l.degToRad(e[0]*e[3])),i.currentTransform.multiply(t)),e[1]&&(t.makeRotationY(l.degToRad(e[1]*e[3])),i.currentTransform.multiply(t)),e[2]&&(t.makeRotationZ(l.degToRad(e[2]*e[3])),i.currentTransform.multiply(t))}}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new s;3==e.length&&(t.makeTranslation(e[0],e[1],e[2]),i.currentTransform.multiply(t))}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),16==e.length&&([1,5,9].forEach((t=>{0==e[t]&&(e[t]=.001)})),0==e[15]&&(e[15]=1),i.currentTransform.fromArray(e))}else i.currentTransform.identity();else i.materialTracker.currentRWXMaterial.opacity=parseFloat(r[2]);else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),3==e.length&&(i.materialTracker.currentRWXMaterial.color=e)}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new n(e[0],e[1],e[2]);if(t.applyMatrix4(i.currentTransform),i.currentBufferVertices.push(t.x,t.y,t.z),void 0!==r[7]){let e=[];r[7].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),i.currentBufferUVs.push(e[0],1-e[1])}else i.currentBufferUVs.push(0,0)}else{const e=parseInt(r[2].match(this.integerRegex)[0]);let t=[];const a=r[3].match(this.integerRegex);for(let r=0;r<e;r++){const e=a[r];t.unshift(parseInt(e)-1)}const s=r.slice(-1)[0];void 0!==s&&ue(i,parseInt(s)),Z(i,t),void 0!==s&&ce(i)}else{let e=[];r[2].match(this.integerRegex).forEach((t=>{e.push(parseInt(t)-1)}));const t=r.slice(-1)[0];void 0!==t?(100==t?he(i,e[0],e[1],e[2],e[3]):i.quadRatioHint=null,ue(i,parseInt(t))):i.quadRatioHint=null,j(i,e[0],e[1],e[2],e[3]),void 0!==t&&(ce(i),fe(i))}else{let e=[];r[2].match(this.integerRegex).forEach((t=>{e.push(parseInt(t)-1)}));const t=r.slice(-1)[0];void 0!==t?(100==t?he(i,e[0],e[1],e[2]):i.triangleRatioHint=null,ue(i,parseInt(t))):i.triangleRatioHint=null,q(i,e[0],e[1],e[2]),void 0!==t&&(ce(i),fe(i))}else{const e=r[2],t=i.rwxPrototypes.get(e).clone();t.applyMatrix4(i.currentTransform),i.currentGroup.add(t)}else O(i),i.currentGroup=u,i.currentTransform=o,ne(i),z(i);else{let e=r[2];u=i.currentGroup,o=i.currentTransform,se(i);const t=new F;t.userData.rwx={},i.rwxPrototypes.set(e,t),i.currentTransform=new s,z(i),i.currentGroup=t}else oe(i);else le(i);else O(i),ne(i),ie(i),z(i);else O(i),z(i),ae(i),se(i)}i.materialTracker.clearCurrentMaterialList(),i.rootGroup.applyMatrix4(c),this.waitFullLoad?Promise.all(i.loadingPromises).then((()=>{a(this.flatten?pe(i.rootGroup):i.rootGroup)})):a(this.flatten?pe(i.rootGroup):i.rootGroup)}}export{ge as RWXMaterial,xe as RWXMaterialManager,de as RWXMaterialTracker,H as makeThreeMaterial,N as makeMaskPromise,P as applyTextureToMat,C as LightSampling,v as GeometrySampling,W as TextureMode,V as MaterialMode,S as TextureAddressMode,D as signTag,G as pictureTag,pe as flattenGroup};
